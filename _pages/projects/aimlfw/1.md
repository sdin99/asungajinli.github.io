---
layout: posts
title: "AIMLFW 환경설정"
permalink: /projects/aimlfw/1/
prev: aimlfw
---

# 1. 우분투 환경설정

우분투 설치 완료되면

```bash
sudo apt-get update && sudo apt-get upgrade
sudo apt-get install htop
```

htop도 설치해준다.

하도 램 부족 문제를 많이 겪어서 htop은 일단 깔아놓자.

다음으로는 Anaconda를 설치해준다. Anaconda 설치가 필수는 아니지만, 개인적으로는 Anaconda 있는게 훨씬 편하기 때문에, 거의 무조건 설치해주자.

```bash
wget https://repo.anaconda.com/archive/Anaconda3-2024.06-1-Linux-x86_64.sh # 최신 버전으로 바꿔주자.
chmod +x Anaconda3-2024.06-1-Linux-x86_64.sh
sh Anaconda3-2024.06-1-Linux-x86_64.sh
```

```bash
echo 'export PATH=~/anaconda3/bin:~/anaconda3/condabin:$PATH' >> ~/.bashrc
source ~/.bashrc
conda config --set auto_activate_base false
conda init
source ~/.bashrc
```

다음으로 kubernetes 자동완성 기능을 추가해준다.

```bash
echo 'source <(kubectl completion bash)' >> ~/.bashrc
source ~/.bashrc
```


# 2. AIMLFW 설치

```bash
git clone "https://gerrit.o-ran-sc.org/r/aiml-fw/aimlfw-dep"
cd aimlfw-dep
```

```bash
bin/install_traininghost.sh
```

스크립트를 이용해 AIMLFW 설치를 진행한다.

`watch kubectl get pods -A`로 진행 상황을 확인할 수 있다.

설치가 완료되었으면 `https://localhost:32005`로 접속해보자.

# 3. InfluxDB 설치

우선 pod를 생성해준다.

```bash
helm repo add bitnami https://charts.bitnami.com/bitnami
helm install my-release bitnami/influxdb --version 5.13.5
```

잘 설치되었으면 InfluxDB token을 가져온다. token을 복사해주자.

```bash
kubectl exec -it <INFLUXDB_POD_NAME> -- cat bitnami/influxdb/influxd.bolt | tr -cd "[:print:]" | grep -o '"token":"[^"]*"' | awk -F\" '{print $4}'"
```

```bash
echo 'export INFLUXDB_TOKEN=<TOKEN>' >> ~/.bashrc
source ~/.bashrc
```

다음으로 Bucket을 만들어준다.

```bash
kubectl exec -it <INFLUXDB_POD_NAME> -- influx bucket create -n UEData -o primary -t $INFLUXDB_TOKEN
```

# 4. InfluxDB 설정

이제 InfluxDB에 데이터를 넣어준다. 우선 InfluxDB 포트포워딩을 해주고,

```bash
kubectl port-forward svc/my-release-influxdb 8086:8086
```

Anaconda를 설치했으면 conda를 이용해 필요한 패키지를 설치한다.

```bash
conda create -n influxdb python=3.8
conda activate influxdb
pip install pandas influxdb_client
```

그리고 InfluxDB에 데이터를 넣어준다. 그 전에 qp 리포지토리를 클론해준다.

```bash
git clone -b f-release https://gerrit.o-ran-sc.org/r/ric-app/qp
```

```bash
cd qp/qp
```

`instert.py` 파일을 아래와 같이 수정해준다.

```python
import pandas as pd
from influxdb_client import InfluxDBClient, Point
from influxdb_client.client.write_api import SYNCHRONOUS
import datetime

org="primary"
token="<TOKEN>"
bucket="UEData"

class INSERTDATA:

   def __init__(self):
        self.client = InfluxDBClient(url= "http://localhost:8086", token=token, org=org)


def explode(df):
     for col in df.columns:
             if isinstance(df.iloc[0][col], list):
                     df = df.explode(col)
             d = df[col].apply(pd.Series)
             df[d.columns] = d
             df = df.drop(col, axis=1)
     return df


def jsonToTable(df):
     df.index = range(len(df))
     cols = [col for col in df.columns if isinstance(df.iloc[0][col], dict) or isinstance(df.iloc[0][col], list)]
     if len(cols) == 0:
             return df
     for col in cols:
             d = explode(pd.DataFrame(df[col], columns=[col]))
             d = d.dropna(axis=1, how='all')
             df = pd.concat([df, d], axis=1)
             df = df.drop(col, axis=1).dropna()
     return jsonToTable(df)


def time(df):
     df.index = pd.to_datetime(pd.date_range(start=datetime.datetime.utcnow(), freq='10ms', periods=len(df)))
     df['measTimeStampRf'] = df['measTimeStampRf'].apply(lambda x: str(x))

     return df


def populatedb():
     df = pd.read_json('cell.json.gz', lines=True)
     df = df[['cellMeasReport']].dropna()
     df = jsonToTable(df)
     df = time(df)
     db = INSERTDATA()
     write_api = db.client.write_api(write_options=SYNCHRONOUS)
     write_api.write(bucket="UEData",record=df, data_frame_measurement_name="liveCell",org=org)
     query_api = db.client.query_api()
     query = f'from(bucket: "{bucket}") |> range(start: -10000d)'
     result = query_api.query(org=org, query=query)
     results = []
     for table in result:
        for record in table.records:
            results.append((record.get_field(), record.get_value()))
     print(results)

print("---start algorithm----")
populatedb()
print("---end algorithm----")
```

`insert.py` 파일을 실행해준다.

```bash
python3 insert.py
```

마지막으로 `aimlfw-dep/RECIPE_EXAMPLE/example_recipe_latest_stable.yaml` 파일을 수정해준다.

```yaml
traininghost:
  ip_address: localhost
...
datalake:
  influxdb:
    host: localhost
    port: 8086
    orgname: primary
    bucket: UEData
    token: <TOKEN>
```

수정사항을 반영해준다.

```bash
bin/uninstall.sh
bin/install.sh -f RECIPE_EXAMPLE/example_recipe_latest_stable.yaml
```

